<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice Search by Site Code, Invoice No, or Customer Name</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e6f2ff;
      padding: 40px;
      color: #004080;
    }
    h1 {
      text-align: center;
      color: #00264d;
      font-weight: 700;
      margin-bottom: 5px;
      font-size: 28px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .as-of-date {
      text-align: center;
      font-size: 16px;
      color: #003366;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .login-container h2 {
      margin-top: 0;
      color: #00264d;
    }
    .login-container input[type="text"],
    .login-container input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      outline: none;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    .login-container button {
      width: 100%;
      padding: 12px 22px;
      font-size: 16px;
      background-color: #3399ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: background-color 0.3s ease;
    }
    .login-container button:hover {
      background-color: #1a8cff;
    }
    .error-message {
      color: #cc0000;
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
    .success-message {
      color: #008000;
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
    #mainApp {
      display: none;
    }
    .logout-btn {
      display: block;
      margin: 30px auto;
      padding: 12px 24px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .logout-btn:hover {
      background-color: #002244;
    }
    .search-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .search-box.wide {
      width: 680px;
    }
    input[type="text"] {
      padding: 12px 16px;
      font-size: 16px;
      width: 90%;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button {
      padding: 12px 22px;
      font-size: 16px;
      background-color: #3399ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover { background-color: #1a8cff; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #cce0ff;
      padding: 12px 14px;
      text-align: left;
    }
    th {
      background-color: #cce6ff;
      color: #003366;
    }
    td.amount { text-align: right; font-family: 'Courier New', Courier, monospace; }
    td.payment { color: #008000; font-weight: 600; }
    .section-title {
      margin-top: 40px;
      font-size: 22px;
      font-weight: 600;
      color: #003366;
      border-bottom: 2px solid #3399ff;
      padding-bottom: 6px;
    }
    .not-found {
      text-align: center;
      font-weight: 700;
      color: #cc0000;
      margin-top: 30px;
      font-size: 18px;
    }
    .grand-total {
      margin-top: 30px;
      text-align: right;
      font-size: 20px;
      font-weight: 700;
      color: #00264d;
    }
    .pdf-button {
      display: block;
      margin: 30px auto 0;
      width: 250px;
      background-color: #004080;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .pdf-button:hover { background-color: #063a73; }
    a.site-link {
      color: #004080;
      text-decoration: underline;
      cursor: pointer;
    }
    .summary-totals {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      gap: 20px;
      flex-wrap: wrap;
    }
    .summary-card {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      text-align: center;
      min-width: 200px;
    }
    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #003366;
      font-size: 18px;
    }
    .summary-card .amount-big {
      font-size: 24px;
      font-weight: 700;
      color: #00264d;
      font-family: 'Courier New', Courier, monospace;
    }
    .age-table {
      overflow-x: auto;
    }
    .age-table table {
      min-width: 900px;
    }
    .age-bracket {
      background-color: #f0f8ff;
    }
    .age-header {
      background-color: #b3d9ff;
    }
    .sort-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
      gap: 10px;
      align-items: center;
    }
    .sort-label {
      font-weight: 600;
      color: #003366;
    }
    .sort-button {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #f0f8ff;
      color: #003366;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      width: auto;
    }
    .sort-button:hover {
      background-color: #e0f0ff;
    }
    .sort-button.active {
      background-color: #3399ff;
      color: white;
      border-color: #3399ff;
    }
    .download-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    .download-button {
      display: block;
      width: 250px;
      background-color: #004080;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-align: center;
    }
    .download-button:hover { background-color: #063a73; }
    .download-button.excel {
      background-color: #107c41;
    }
    .download-button.excel:hover { background-color: #0e5e2e; }
    .download-button.secondary {
      background-color: #6c757d;
    }
    .download-button.secondary:hover { background-color: #5a6268; }
    .download-button.secondary.excel {
      background-color: #6f8a52;
    }
    .download-button.secondary.excel:hover { background-color: #5a6e42; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h1>DOK Solutions Lanka (Pvt) Ltd</h1>
    <h2>Login to Outstanding Summary</h2>
    <input type="text" id="username" placeholder="Enter Username" onkeypress="handleLoginKeyPress(event)" />
    <input type="password" id="password" placeholder="Enter Password" onkeypress="handleLoginKeyPress(event)" />
    <button onclick="login()">Login</button>
    <div id="loginMessage"></div>
  </div>

  <!-- Main Application (Hidden until login) -->
  <div id="mainApp">
    <h1>DOK Solutions Lanka (Pvt) Ltd</h1>
    <h2>Outstanding Invoice Search</h2>
    <div id="asOfDate" class="as-of-date"></div>

    <div class="search-container">
      <div class="search-box">
        <h3>Search by Site Code</h3>
        <input type="text" id="siteCodeInput" placeholder="Enter Site Code (e.g. CCC01)" onkeypress="handleKeyPress(event, 'site')" />
        <button onclick="searchBySiteCode()">Search Site Code</button>
      </div>

      <div class="search-box">
        <h3>Search by Invoice Number</h3>
        <input type="text" id="invoiceNoInput" placeholder="Enter Invoice Number" onkeypress="handleKeyPress(event, 'invoice')" />
        <button onclick="searchByInvoiceNo()">Search Invoice No</button>
      </div>

      <div class="search-box wide">
        <h3>Find Site by Customer Name</h3>
        <input type="text" id="customerNameInput" placeholder="Enter part of Customer Name" onkeypress="handleKeyPress(event, 'customer')" />
        <button onclick="searchByCustomerName()">Find Site</button>
      </div>

      <div class="search-box wide">
        <h3>Total Customer Outstanding Summary</h3>
        <button onclick="showCustomerSummary()">Show All Customer Outstandings</button>
      </div>

      <div class="search-box wide">
        <h3>Customer Outstanding (Without Excess Payments)</h3>
        <button onclick="showCustomerSummaryWithoutExcess()">Show Outstanding Without Excess</button>
      </div>

      <div class="search-box wide">
        <h3>Age Analysis (Customer Wise)</h3>
        <button onclick="showAgeAnalysis()">Show Age Analysis</button>
      </div>
    </div>

    <div id="results"></div>
    
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1pwJypDTNH5ouw4BZ7gB_2AchH1TRktzhKxVaBGg7hzo/gviz/tq?tqx=out:json';
    let currentSiteCode = '';
    let rawSummaryData = null;
    let rawSummaryWithoutExcessData = null;
    let rawAgeAnalysisData = null;
    let currentSortType = 'alphabetical'; // 'alphabetical' or 'amount'
    let currentView = null; // 'summary', 'summaryWithoutExcess', 'statement', or 'ageAnalysis'
    let isLoggedIn = false;
    let allCustomers = [];
    let isWithoutExcessView = false; // Track if we're in the "without excess" view

    async function fetchSheetData() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        if (!json.table || !json.table.rows) return [];
        return json.table.rows;
      } catch (error) {
        console.error('Error fetching sheet data:', error);
        return [];
      }
    }

    function handleLoginKeyPress(event) {
      if (event.key === 'Enter') {
        login();
      }
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const messageDiv = document.getElementById('loginMessage');

      if (!username || !password) {
        messageDiv.innerHTML = '<div class="error-message">Please enter both username and password</div>';
        return;
      }

      messageDiv.innerHTML = '<div class="success-message">Validating credentials...</div>';

      const rows = await fetchSheetData();
      let loginSuccess = false;

      // Check credentials from columns J (index 9) and K (index 10)
      // Starting from row 2 (index 1) as row 1 is header
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        
        // Get username from column J (index 9) and password from column K (index 10)
        const storedUsername = row.c[9]?.v?.toString().trim() || '';
        const storedPassword = row.c[10]?.v?.toString().trim() || '';

        if (storedUsername === username && storedPassword === password) {
          loginSuccess = true;
          break;
        }
      }

      if (loginSuccess) {
        messageDiv.innerHTML = '<div class="success-message">Login successful! Redirecting...</div>';
        isLoggedIn = true;
        
        setTimeout(async () => {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          // Fetch and display "As of Date" after showing main app
          await fetchAsOfDate();
          await loadAllCustomers();
        }, 1000);
      } else {
        messageDiv.innerHTML = '<div class="error-message">Invalid username or password</div>';
        document.getElementById('password').value = '';
      }
    }

    function logout() {
      isLoggedIn = false;
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginMessage').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('asOfDate').innerHTML = '';
      currentSortType = 'alphabetical';
      currentView = null;
      rawSummaryData = null;
      rawSummaryWithoutExcessData = null;
      rawAgeAnalysisData = null;
      allCustomers = [];
      isWithoutExcessView = false;
    }

    async function fetchAsOfDate() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        
        console.log('Full JSON:', json);
        
        if (json.table && json.table.cols && json.table.cols.length > 0) {
          // Get the label from the first column header which contains A1 data
          const firstColLabel = json.table.cols[0].label || '';
          console.log('Column label (A1):', firstColLabel);
          
          if (firstColLabel) {
            document.getElementById('asOfDate').innerHTML = firstColLabel.toString();
          } else {
            document.getElementById('asOfDate').innerHTML = 'As of Date not found';
          }
        }
      } catch (error) {
        console.error('Error fetching As of Date:', error);
        document.getElementById('asOfDate').innerHTML = 'Error loading date';
      }
    }

    async function loadAllCustomers() {
      const rows = await fetchSheetData();
      const customerMap = new Map();

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        
        if (siteCode && customerName && !customerMap.has(siteCode)) {
          customerMap.set(siteCode, customerName);
        }
      });

      allCustomers = Array.from(customerMap.entries()).map(([siteCode, customerName]) => ({
        siteCode,
        customerName,
        displayName: `${customerName} (${siteCode})`
      })).sort((a, b) => a.customerName.localeCompare(b.customerName));
    }

    function handleKeyPress(event, type) {
      if (event.key === 'Enter') {
        if (type === 'site') searchBySiteCode();
        else if (type === 'invoice') searchByInvoiceNo();
        else if (type === 'customer') searchByCustomerName();
      }
    }

    function formatAmount(num) {
      return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Improved date parsing function to handle various date formats
    function parseDate(dateString) {
      if (!dateString) return null;
      
      // Try to parse with Date.parse first
      const parsed = Date.parse(dateString);
      if (!isNaN(parsed)) return new Date(parsed);
      
      // Try different date formats
      // Format: dd/mm/yyyy
      const ddmmyyyy = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (ddmmyyyy) {
        return new Date(parseInt(ddmmyyyy[3]), parseInt(ddmmyyyy[2]) - 1, parseInt(ddmmyyyy[1]));
      }
      
      // Format: dd-mm-yyyy
      const ddmmyyyy2 = dateString.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (ddmmyyyy2) {
        return new Date(parseInt(ddmmyyyy2[3]), parseInt(ddmmyyyy2[2]) - 1, parseInt(ddmmyyyy2[1]));
      }
      
      // Format: mm/dd/yyyy
      const mmddyyyy = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (mmddyyyy) {
        return new Date(parseInt(mmddyyyy[3]), parseInt(mmddyyyy[1]) - 1, parseInt(mmddyyyy[2]));
      }
      
      // Format: yyyy-mm-dd
      const yyyymmdd = dateString.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (yyyymmdd) {
        return new Date(parseInt(yyyymmdd[1]), parseInt(yyyymmdd[2]) - 1, parseInt(yyyymmdd[3]));
      }
      
      // If all else fails, return null
      return null;
    }

    function calculateAge(invoiceDate) {
      // Parse the invoice date using our improved parseDate function
      const invDate = parseDate(invoiceDate);
      if (!invDate) return 0;
      
      const today = new Date();
      
      // Calculate difference in days
      const diffTime = Math.abs(today - invDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }

    function getAgeBracket(days) {
      if (days <= 30) return '0-30';
      if (days <= 60) return '31-60';
      if (days <= 90) return '61-90';
      if (days <= 180) return '91-180';
      if (days <= 360) return '181-360';
      return '>360';
    }

    function sortData(data, sortType) {
      if (sortType === 'alphabetical') {
        return data.sort((a, b) => a.customerName.localeCompare(b.customerName));
      } else if (sortType === 'amount') {
        return data.sort((a, b) => {
          // Get the correct total value based on data type
          const totalA = a.grandTotal !== undefined ? a.grandTotal : (a.total !== undefined ? a.total : 0);
          const totalB = b.grandTotal !== undefined ? b.grandTotal : (b.total !== undefined ? b.total : 0);
          return totalB - totalA; // Large to small
        });
      }
      return data;
    }

    function renderSortButtons(viewType) {
      return `
        <div class="sort-container">
          <span class="sort-label">Sort by:</span>
          <button class="sort-button ${currentSortType === 'alphabetical' ? 'active' : ''}" 
                  onclick="changeSortType('alphabetical', '${viewType}')">
            Customer Name (A-Z)
          </button>
          <button class="sort-button ${currentSortType === 'amount' ? 'active' : ''}" 
                  onclick="changeSortType('amount', '${viewType}')">
            Total Outstanding (High to Low)
          </button>
        </div>
      `;
    }

    function changeSortType(sortType, viewType) {
      currentSortType = sortType;
      
      // Re-sort the data and re-render
      if (viewType === 'summary' && rawSummaryData) {
        const sortedData = sortData([...rawSummaryData], sortType);
        renderCustomerSummary(sortedData);
      } else if (viewType === 'summaryWithoutExcess' && rawSummaryWithoutExcessData) {
        const sortedData = sortData([...rawSummaryWithoutExcessData], sortType);
        renderCustomerSummaryWithoutExcess(sortedData);
      } else if (viewType === 'ageAnalysis' && rawAgeAnalysisData) {
        const sortedData = sortData([...rawAgeAnalysisData], sortType);
        renderAgeAnalysis(sortedData);
      }
    }

    async function showAgeAnalysis() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found">Loading age analysis data...</div>`;

      const rows = await fetchSheetData();
      const customerAgeData = {};

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        const description = row.c[5]?.v || '';
        const amountRaw = row.c[6]?.v || 0;
        // Get date from Column E (index 4)
        const date = row.c[4]?.f || row.c[4]?.v || '';

        if (!siteCode || !customerName) return;

        // Create a unique key for each customer
        const customerKey = `${customerName} (${siteCode})`;

        if (!customerAgeData[customerKey]) {
          customerAgeData[customerKey] = {
            customerName,
            siteCode,
            '0-30': 0,
            '31-60': 0,
            '61-90': 0,
            '91-180': 0,
            '181-360': 0,
            '>360': 0,
            total: 0
          };
        }

        // Calculate age and add to appropriate bracket
        const age = calculateAge(date);
        const bracket = getAgeBracket(age);
        
        // For payments, we want to show them as negative amounts in age analysis
        let amount = amountRaw;
        if (description.toLowerCase() === 'payment') {
          amount = -Math.abs(amountRaw);
        }
        
        customerAgeData[customerKey][bracket] += amount;
        customerAgeData[customerKey].total += amount;
      });

      // Convert to array for sorting and display
      const ageAnalysisArray = Object.entries(customerAgeData).map(([key, data]) => ({
        key,
        ...data
      })).filter(item => item.total !== 0); // Include customers with net zero (payments equal invoices)

      // Store raw data and sort by default
      rawAgeAnalysisData = ageAnalysisArray;
      const sortedData = sortData([...ageAnalysisArray], currentSortType);
      
      currentView = 'ageAnalysis';
      isWithoutExcessView = false;

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No outstanding invoices found for age analysis.</div>`;
        return;
      }

      renderAgeAnalysis(sortedData);
    }

    function renderAgeAnalysis(data) {
      const resultsDiv = document.getElementById('results');
      const ageAnalysisArray = data;

      // Calculate totals for each age bracket
      let total0_30 = 0;
      let total31_60 = 0;
      let total61_90 = 0;
      let total91_180 = 0;
      let total181_360 = 0;
      let totalOver360 = 0;
      let grandTotal = 0;

      let html = renderSortButtons('ageAnalysis');
      html += `<div class="section-title">Age Analysis (Customer Wise)</div>
               <div class="age-table">
               <table>
                 <thead>
                   <tr>
                     <th>Customer Name</th>
                     <th>Site Code</th>
                     <th class="age-header">0-30 Days</th>
                     <th class="age-header">31-60 Days</th>
                     <th class="age-header">61-90 Days</th>
                     <th class="age-header">91-180 Days</th>
                     <th class="age-header">181-360 Days</th>
                     <th class="age-header">>360 Days</th>
                     <th>Total Outstanding</th>
                   </tr>
                 </thead>
                 <tbody>`;

      ageAnalysisArray.forEach(item => {
        total0_30 += item['0-30'];
        total31_60 += item['31-60'];
        total61_90 += item['61-90'];
        total91_180 += item['91-180'];
        total181_360 += item['181-360'];
        totalOver360 += item['>360'];
        grandTotal += item.total;

        html += `<tr>
          <td>${item.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${item.siteCode}')">${item.siteCode}</a></td>
          <td class="amount">${formatAmount(item['0-30'])}</td>
          <td class="amount">${formatAmount(item['31-60'])}</td>
          <td class="amount">${formatAmount(item['61-90'])}</td>
          <td class="amount">${formatAmount(item['91-180'])}</td>
          <td class="amount">${formatAmount(item['181-360'])}</td>
          <td class="amount">${formatAmount(item['>360'])}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.total)}</td>
        </tr>`;
      });

      html += `<tr style="background-color: #e6f2ff; font-weight: 700;">
        <td colspan="2" style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${formatAmount(total0_30)}</td>
        <td class="amount">${formatAmount(total31_60)}</td>
        <td class="amount">${formatAmount(total61_90)}</td>
        <td class="amount">${formatAmount(total91_180)}</td>
        <td class="amount">${formatAmount(total181_360)}</td>
        <td class="amount">${formatAmount(totalOver360)}</td>
        <td class="amount">${formatAmount(grandTotal)}</td>
      </tr>`;

      html += `</tbody></table></div>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3>0-30 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total0_30)}</div>
        </div>
        <div class="summary-card">
          <h3>31-60 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total31_60)}</div>
        </div>
        <div class="summary-card">
          <h3>61-90 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total61_90)}</div>
        </div>
        <div class="summary-card">
          <h3>91-180 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total91_180)}</div>
        </div>
        <div class="summary-card">
          <h3>181-360 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(total181_360)}</div>
        </div>
        <div class="summary-card">
          <h3>>360 Days</h3>
          <div class="amount-big">Rs. ${formatAmount(totalOver360)}</div>
        </div>
        <div class="summary-card">
          <h3>Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(grandTotal)}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadAgeAnalysisPDF()">Download as PDF</button>
        <button class="download-button excel" onclick="downloadAgeAnalysisExcel()">Download as Excel</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadAgeAnalysisPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Age Analysis (Customer Wise)', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results .age-table table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' },
          6: { halign: 'right' },
          7: { halign: 'right' },
          8: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Age Analysis.pdf');
    }

    function downloadAgeAnalysisExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Get the current date for the report
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Prepare data for Excel with proper formatting
      const wsData = [];
      
      // Add title and company information
      wsData.push(['DOK Solutions Lanka (Pvt) Ltd']);
      wsData.push(['Age Analysis (Customer Wise)']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      // Add headers
      wsData.push([
        'Customer Name', 
        'Site Code', 
        '0-30 Days', 
        '31-60 Days', 
        '61-90 Days', 
        '91-180 Days', 
        '181-360 Days', 
        '>360 Days', 
        'Total Outstanding'
      ]);
      
      // Add data rows with proper number formatting
      const ageAnalysisArray = currentView === 'ageAnalysis' ? 
        (document.querySelector('#results .age-table tbody') ? 
          Array.from(document.querySelector('#results .age-table tbody').rows).slice(0, -1) : []) : [];
      
      ageAnalysisArray.forEach(row => {
        const rowData = [];
        for (let i = 0; i < row.cells.length; i++) {
          let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
          
          // Convert text amounts to numbers for Excel (remove formatting)
          if (i >= 2 && i <= 8) { // Amount columns
            cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
            cellValue = parseFloat(cellValue) || 0;
          }
          
          rowData.push(cellValue);
        }
        wsData.push(rowData);
      });
      
      // Add totals row
      const totalsRow = document.querySelector('#results .age-table tbody tr:last-child');
      if (totalsRow) {
        const totalsData = [];
        for (let i = 0; i < totalsRow.cells.length; i++) {
          let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
          
          // Convert text amounts to numbers for Excel
          if (i >= 2 && i <= 8) { // Amount columns
            cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
            cellValue = parseFloat(cellValue) || 0;
          }
          
          totalsData.push(cellValue);
        }
        wsData.push(totalsData);
      }
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      const colWidths = [
        { wch: 35 }, // Customer Name
        { wch: 15 }, // Site Code
        { wch: 18 }, // 0-30 Days
        { wch: 18 }, // 31-60 Days
        { wch: 18 }, // 61-90 Days
        { wch: 18 }, // 91-180 Days
        { wch: 18 }, // 181-360 Days
        { wch: 18 }, // >360 Days
        { wch: 22 }  // Total Outstanding
      ];
      ws['!cols'] = colWidths;
      
      // Apply professional styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style title and headers
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Company title styling
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } });
            }
          }
          // Report title styling
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge report title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 8 } });
            }
          }
          // Date information styling
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            // Merge date cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 8 } });
            }
          }
          // Header row styling
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          // Data rows styling
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 8) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 8) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          // Totals row styling
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 8) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 8) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Age Analysis");
      
      // Generate and download the Excel file
      const fileName = `Age Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showCustomerSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found">Loading customer summary data...</div>`;

      const rows = await fetchSheetData();
      const customerData = {};

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        const description = row.c[5]?.v || '';
        const amountRaw = row.c[6]?.v || 0;

        if (!siteCode || !customerName) return;

        if (!customerData[siteCode]) {
          customerData[siteCode] = {
            customerName,
            paTotal: 0,
            daTotal: 0,
            excessPayment: 0
          };
        }

        if (description === 'PA Manual Invoice') {
          customerData[siteCode].paTotal += amountRaw;
        } else if (description === 'DA Manual Invoice') {
          customerData[siteCode].daTotal += amountRaw;
        } else if (description.toLowerCase() === 'payment') {
          customerData[siteCode].excessPayment += amountRaw;
        }
      });

      const summaryArray = Object.entries(customerData).map(([siteCode, data]) => ({
        siteCode,
        customerName: data.customerName,
        paTotal: data.paTotal,
        daTotal: data.daTotal,
        excessPayment: data.excessPayment,
        grandTotal: data.paTotal + data.daTotal + data.excessPayment
      })).filter(item => item.paTotal !== 0 || item.daTotal !== 0 || item.excessPayment !== 0);

      // Store raw data and sort by default
      rawSummaryData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      currentView = 'summary';
      isWithoutExcessView = false;

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No outstanding invoices found.</div>`;
        return;
      }

      renderCustomerSummary(sortedData);
    }

    function renderCustomerSummary(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalPA = 0;
      let totalDA = 0;
      let totalExcess = 0;
      let totalGrand = 0;

      let html = renderSortButtons('summary');
      html += `<div class="section-title">Total Customer Outstanding Summary (PA & DA)</div>
               <table>
                 <thead>
                   <tr>
                     <th>Customer Name</th>
                     <th>Site Code</th>
                     <th>PA Outstanding (Rs.)</th>
                     <th>DA Outstanding (Rs.)</th>
                     <th>Excess Payment (Rs.)</th>
                     <th>Total Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalPA += item.paTotal;
        totalDA += item.daTotal;
        totalExcess += item.excessPayment;
        totalGrand += item.grandTotal;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td>${item.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${item.siteCode}')">${item.siteCode}</a></td>
          <td class="amount">${formatAmount(item.paTotal)}</td>
          <td class="amount">${formatAmount(item.daTotal)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.grandTotal)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr style="background-color: #e6f2ff; font-weight: 700;">
        <td colspan="2" style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${formatAmount(totalPA)}</td>
        <td class="amount">${formatAmount(totalDA)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalGrand)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3>Total PA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalPA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total DA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalDA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total Excess Payments</h3>
          <div class="amount-big" style="color: #008000;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3>Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalGrand)}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadSummaryPDF()">Download as PDF</button>
        <button class="download-button excel" onclick="downloadSummaryExcel()">Download as Excel</button>
        <button class="download-button secondary" onclick="downloadSummaryPDFWithoutExcess()">Download PDF (Without Excess)</button>
        <button class="download-button secondary excel" onclick="downloadSummaryExcelWithoutExcess()">Download Excel (Without Excess)</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Total Customer Outstanding Summary (PA & DA)', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Customer Outstanding Summary.pdf');
    }

    function downloadSummaryExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Get the current date for the report
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Prepare data for Excel with proper formatting
      const wsData = [];
      
      // Add title and company information
      wsData.push(['DOK Solutions Lanka (Pvt) Ltd']);
      wsData.push(['Total Customer Outstanding Summary (PA & DA)']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      // Add headers
      wsData.push([
        'Customer Name', 
        'Site Code', 
        'PA Outstanding (Rs.)', 
        'DA Outstanding (Rs.)', 
        'Excess Payment (Rs.)', 
        'Total Outstanding (Rs.)'
      ]);
      
      // Add data rows with proper number formatting
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1); // Exclude totals row
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            // Convert text amounts to numbers for Excel (remove formatting)
            if (i >= 2 && i <= 5) { // Amount columns
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        // Add totals row
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            // Convert text amounts to numbers for Excel
            if (i >= 2 && i <= 5) { // Amount columns
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      const colWidths = [
        { wch: 35 }, // Customer Name
        { wch: 15 }, // Site Code
        { wch: 22 }, // PA Outstanding
        { wch: 22 }, // DA Outstanding
        { wch: 22 }, // Excess Payment
        { wch: 25 }  // Total Outstanding
      ];
      ws['!cols'] = colWidths;
      
      // Apply professional styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style title and headers
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Company title styling
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } });
            }
          }
          // Report title styling
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge report title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 5 } });
            }
          }
          // Date information styling
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            // Merge date cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 5 } });
            }
          }
          // Header row styling
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          // Data rows styling
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 5) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 5) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          // Totals row styling
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 5) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 5) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Customer Summary");
      
      // Generate and download the Excel file
      const fileName = `Customer Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    function downloadSummaryPDFWithoutExcess() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Customer Outstanding Summary', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      // Create table data without excess payments
      const table = document.querySelector('#results table');
      const tableData = [];
      
      // Add headers
      const headers = ['Customer Name', 'Site Code', 'PA Outstanding (Rs.)', 'DA Outstanding (Rs.)', 'Total Outstanding (Rs.)'];
      tableData.push(headers);
      
      // Add data rows (excluding excess payment column)
      const rows = table.querySelectorAll('tbody tr');
      Array.from(rows).slice(0, -1).forEach(row => {
        const rowData = [
          row.cells[0].textContent, // Customer Name
          row.cells[1].textContent, // Site Code
          row.cells[2].textContent, // PA Outstanding
          row.cells[3].textContent, // DA Outstanding
          row.cells[5].textContent  // Total Outstanding (skip excess payment)
        ];
        tableData.push(rowData);
      });
      
      // Add totals row (modified)
      const totalsRow = rows[rows.length - 1];
      if (totalsRow) {
        const totalsData = [
          'GRAND TOTAL',
          '',
          totalsRow.cells[2].textContent, // PA Total
          totalsRow.cells[3].textContent, // DA Total
          totalsRow.cells[5].textContent  // Grand Total
        ];
        tableData.push(totalsData);
      }
      
      doc.autoTable({
        head: [headers],
        body: tableData.slice(1),
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Customer Outstanding Summary.pdf');
    }

    function downloadSummaryExcelWithoutExcess() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Get the current date for the report
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Prepare data for Excel with proper formatting
      const wsData = [];
      
      // Add title and company information
      wsData.push(['DOK Solutions Lanka (Pvt) Ltd']);
      wsData.push(['Customer Outstanding Summary']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      // Add headers (without excess payment column)
      wsData.push([
        'Customer Name', 
        'Site Code', 
        'PA Outstanding (Rs.)', 
        'DA Outstanding (Rs.)', 
        'Total Outstanding (Rs.)'
      ]);
      
      // Add data rows with proper number formatting (excluding excess payment)
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1); // Exclude totals row
        rows.forEach(row => {
          const rowData = [];
          // Skip excess payment column (index 4)
          for (let i = 0; i < row.cells.length; i++) {
            if (i === 4) continue; // Skip excess payment column
            
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            // Convert text amounts to numbers for Excel (remove formatting)
            if (i >= 2 && i <= 3) { // Amount columns
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            } else if (i === 5) { // Total column
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        // Add totals row (modified)
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [
            'GRAND TOTAL',
            '',
            parseFloat(totalsRow.cells[2].textContent.replace(/,/g, '').replace(/Rs\.\s*/, '') || 0), // PA Total
            parseFloat(totalsRow.cells[3].textContent.replace(/,/g, '').replace(/Rs\.\s*/, '') || 0), // DA Total
            parseFloat(totalsRow.cells[5].textContent.replace(/,/g, '').replace(/Rs\.\s*/, '') || 0)  // Grand Total
          ];
          wsData.push(totalsData);
        }
      }
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      const colWidths = [
        { wch: 35 }, // Customer Name
        { wch: 15 }, // Site Code
        { wch: 22 }, // PA Outstanding
        { wch: 22 }, // DA Outstanding
        { wch: 25 }  // Total Outstanding
      ];
      ws['!cols'] = colWidths;
      
      // Apply professional styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style title and headers
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Company title styling
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          // Report title styling
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge report title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          // Date information styling
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            // Merge date cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          // Header row styling
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          // Data rows styling
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          // Totals row styling
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Customer Summary");
      
      // Generate and download the Excel file
      const fileName = `Customer Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function showCustomerSummaryWithoutExcess() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found">Loading customer summary data (without excess payments)...</div>`;

      const rows = await fetchSheetData();
      const customerData = {};

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        const description = row.c[5]?.v || '';
        const amountRaw = row.c[6]?.v || 0;

        if (!siteCode || !customerName) return;

        if (!customerData[siteCode]) {
          customerData[siteCode] = {
            customerName,
            paTotal: 0,
            daTotal: 0
          };
        }

        if (description === 'PA Manual Invoice') {
          customerData[siteCode].paTotal += amountRaw;
        } else if (description === 'DA Manual Invoice') {
          customerData[siteCode].daTotal += amountRaw;
        }
        // Skip excess payments for this report
      });

      const summaryArray = Object.entries(customerData).map(([siteCode, data]) => ({
        siteCode,
        customerName: data.customerName,
        paTotal: data.paTotal,
        daTotal: data.daTotal,
        grandTotal: data.paTotal + data.daTotal
      })).filter(item => item.paTotal !== 0 || item.daTotal !== 0);

      // Store raw data and sort by default
      rawSummaryWithoutExcessData = summaryArray;
      const sortedData = sortData([...summaryArray], currentSortType);
      
      currentView = 'summaryWithoutExcess';
      isWithoutExcessView = true;

      if (sortedData.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No outstanding invoices found.</div>`;
        return;
      }

      renderCustomerSummaryWithoutExcess(sortedData);
    }

    function renderCustomerSummaryWithoutExcess(data) {
      const resultsDiv = document.getElementById('results');
      const summaryArray = data;

      let totalPA = 0;
      let totalDA = 0;
      let totalGrand = 0;

      let html = renderSortButtons('summaryWithoutExcess');
      html += `<div class="section-title">Customer Outstanding Summary (Without Excess Payments)</div>
               <table>
                 <thead>
                   <tr>
                     <th>Customer Name</th>
                     <th>Site Code</th>
                     <th>PA Outstanding (Rs.)</th>
                     <th>DA Outstanding (Rs.)</th>
                     <th>Total Outstanding (Rs.)</th>
                   </tr>
                 </thead>
                 <tbody>`;

      summaryArray.forEach(item => {
        totalPA += item.paTotal;
        totalDA += item.daTotal;
        totalGrand += item.grandTotal;

        html += `<tr>
          <td>${item.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${item.siteCode}')">${item.siteCode}</a></td>
          <td class="amount">${formatAmount(item.paTotal)}</td>
          <td class="amount">${formatAmount(item.daTotal)}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.grandTotal)}</td>
        </tr>`;
      });

      html += `<tr style="background-color: #e6f2ff; font-weight: 700;">
        <td colspan="2" style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${formatAmount(totalPA)}</td>
        <td class="amount">${formatAmount(totalDA)}</td>
        <td class="amount">${formatAmount(totalGrand)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3>Total PA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalPA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total DA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalDA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalGrand)}</div>
        </div>
      </div>`;

      html += `<div class="download-container">
        <button class="download-button" onclick="downloadSummaryWithoutExcessPDF()">Download as PDF</button>
        <button class="download-button excel" onclick="downloadSummaryWithoutExcessExcel()">Download as Excel</button>
      </div>`;

      resultsDiv.innerHTML = html;
    }

    function downloadSummaryWithoutExcessPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Customer Outstanding Summary', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Customer Outstanding Summary.pdf');
    }

    function downloadSummaryWithoutExcessExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Get the current date for the report
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Prepare data for Excel with proper formatting
      const wsData = [];
      
      // Add title and company information
      wsData.push(['DOK Solutions Lanka (Pvt) Ltd']);
      wsData.push(['Customer Outstanding Summary']);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      // Add headers
      wsData.push([
        'Customer Name', 
        'Site Code', 
        'PA Outstanding (Rs.)', 
        'DA Outstanding (Rs.)', 
        'Total Outstanding (Rs.)'
      ]);
      
      // Add data rows with proper number formatting
      const summaryTable = document.querySelector('#results table tbody');
      if (summaryTable) {
        const rows = Array.from(summaryTable.rows).slice(0, -1); // Exclude totals row
        rows.forEach(row => {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            let cellValue = row.cells[i].innerText || row.cells[i].textContent || '';
            
            // Convert text amounts to numbers for Excel (remove formatting)
            if (i >= 2 && i <= 4) { // Amount columns
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          }
          wsData.push(rowData);
        });
        
        // Add totals row
        const totalsRow = summaryTable.rows[summaryTable.rows.length - 1];
        if (totalsRow) {
          const totalsData = [];
          for (let i = 0; i < totalsRow.cells.length; i++) {
            let cellValue = totalsRow.cells[i].innerText || totalsRow.cells[i].textContent || '';
            
            // Convert text amounts to numbers for Excel
            if (i >= 2 && i <= 4) { // Amount columns
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            totalsData.push(cellValue);
          }
          wsData.push(totalsData);
        }
      }
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      const colWidths = [
        { wch: 35 }, // Customer Name
        { wch: 15 }, // Site Code
        { wch: 22 }, // PA Outstanding
        { wch: 22 }, // DA Outstanding
        { wch: 25 }  // Total Outstanding
      ];
      ws['!cols'] = colWidths;
      
      // Apply professional styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style title and headers
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Company title styling
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          // Report title styling
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge report title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          // Date information styling
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            // Merge date cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          // Header row styling
          else if (R === 5) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          // Data rows styling
          else if (R > 5 && R < wsData.length - 1) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          // Totals row styling
          else if (R === wsData.length - 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C >= 2 && C <= 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            // Apply accounting number format to amount columns
            if (C >= 2 && C <= 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Customer Summary");
      
      // Generate and download the Excel file
      const fileName = `Customer Outstanding Summary_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function searchByCustomerName() {
      const input = document.getElementById('customerNameInput').value.trim().toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter part of a customer name.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      const matches = [];

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        if (customerName.toLowerCase().includes(input)) {
          if (!matches.find(m => m.siteCode === siteCode)) {
            matches.push({ siteCode, customerName });
          }
        }
      });

      if (matches.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No sites found for Customer Name containing: <strong>${input}</strong></div>`;
        return;
      }

      let html = `<div class="section-title">Matching Sites</div><table><thead><tr>
        <th>Customer Name</th><th>Site Code</th></tr></thead><tbody>`;

      matches.forEach(m => {
        html += `<tr>
          <td>${m.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${m.siteCode}')">${m.siteCode}</a></td>
        </tr>`;
      });

      html += `</tbody></table>`;
      resultsDiv.innerHTML = html;
    }

    async function searchBySiteCode(code = null) {
      const input = (code || document.getElementById('siteCodeInput').value.trim().toUpperCase());
      currentSiteCode = input;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter a site code to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      const paInvoices = [];
      const daInvoices = [];
      const payments = [];

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        if (siteCode === input) {
          const customerName = row.c[2]?.v || '';
          const invNo = row.c[3]?.v || '';
          // Get date from Column E (index 4)
          const date = row.c[4]?.f || row.c[4]?.v || '';
          const description = row.c[5]?.v || '';
          const amountRaw = row.c[6]?.v || 0;
          const record = { customerName, invNo, date, description, amountRaw };

          if (description === 'PA Manual Invoice') paInvoices.push(record);
          else if (description === 'DA Manual Invoice') daInvoices.push(record);
          else if (description.toLowerCase() === 'payment') payments.push(record);
        }
      });

      function sortInvoices(invoices) {
        return invoices.sort((a, b) => {
          const dateA = parseDate(a.date);
          const dateB = parseDate(b.date);
          if (!dateA) return 1;
          if (!dateB) return -1;
          return dateA - dateB;
        });
      }

      const sortedPA = sortInvoices(paInvoices);
      const sortedDA = sortInvoices(daInvoices);

      // Only include payments if we're not in the "without excess" view
      if (!isWithoutExcessView) {
        payments.forEach(p => {
          const record = { ...p, description: 'Excess Payment', amountRaw: -Math.abs(p.amountRaw) };
          if (sortedPA.length > 0 && sortedDA.length === 0) sortedPA.push(record);
          else if (sortedDA.length > 0 && sortedPA.length === 0) sortedDA.push(record);
          else sortedPA.push(record);
        });
      }

      if (sortedPA.length === 0 && sortedDA.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No invoices or payments found for Site Code: <strong>${input}</strong></div>`;
        return;
      }

      function buildTable(title, invoices) {
        let total = 0;
        let tableHTML = `<div class="section-title">${title}</div><table><thead><tr>
          <th>Customer Name</th><th>Invoice No / Ref</th><th>Date</th><th>Description</th><th>Amount (Rs.)</th>
        </tr></thead><tbody>`;

        invoices.forEach(({ customerName, invNo, date, description, amountRaw }) => {
          const isPayment = description.toLowerCase().includes('payment');
          const displayAmount = isPayment ? `(${formatAmount(Math.abs(amountRaw))})` : formatAmount(amountRaw);
          const amountClass = isPayment ? 'amount payment' : 'amount';
          total += amountRaw;

          tableHTML += `<tr>
            <td>${customerName}</td>
            <td>${invNo}</td>
            <td>${date}</td>
            <td>${description}</td>
            <td class="${amountClass}">${displayAmount}</td>
          </tr>`;
        });

        tableHTML += `<tr><td colspan="4" style="text-align:right; font-weight:700;">Total Outstanding</td>
          <td class="amount" style="font-weight:700;">${formatAmount(total)}</td></tr></tbody></table>`;
        return { html: tableHTML, total };
      }

      let html = '';
      let paTotal = 0;
      let daTotal = 0;
      if (sortedPA.length > 0) {
        const { html: paHTML, total } = buildTable('Outstanding PA Invoices', sortedPA);
        html += paHTML; paTotal = total;
      }
      if (sortedDA.length > 0) {
        const { html: daHTML, total } = buildTable('Outstanding DA Invoices', sortedDA);
        html += daHTML; daTotal = total;
      }

      const grandTotal = paTotal + daTotal;
      const titleText = isWithoutExcessView 
        ? `Total Outstanding (PA + DA): Rs. ${formatAmount(grandTotal)}`
        : `Total Outstanding (PA + DA): Rs. ${formatAmount(grandTotal)}`;
      
      html += `<div class="grand-total">${titleText}</div>
               <div class="download-container">
                 <button class="download-button" onclick="downloadPDF()">Download as PDF</button>
                 <button class="download-button excel" onclick="downloadSiteCodeExcel()">Download as Excel</button>
               </div>`;
      resultsDiv.innerHTML = html;
    }

    function downloadSiteCodeExcel() {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Get the current date for the report
      const reportDate = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Prepare data for Excel with proper formatting
      const wsData = [];
      
      // Add title and company information
      wsData.push(['DOK Solutions Lanka (Pvt) Ltd']);
      wsData.push([`Outstanding Invoices - Site Code: ${currentSiteCode}`]);
      wsData.push([`As of: ${reportDate}`]);
      wsData.push([`Generated: ${new Date().toLocaleString()}`]);
      wsData.push([]);
      
      // Process each table
      const tables = document.querySelectorAll('#results table');
      let currentRow = 6;
      
      tables.forEach((table, tableIndex) => {
        if (tableIndex > 0) {
          wsData.push([]); // Add space between tables
          currentRow++;
        }
        
        // Get table title from previous div
        const titleElement = table.previousElementSibling;
        if (titleElement && titleElement.classList.contains('section-title')) {
          wsData.push([titleElement.textContent]);
          currentRow++;
        }
        
        // Add headers
        const headers = [];
        const headerCells = table.querySelectorAll('thead th');
        headerCells.forEach(cell => {
          headers.push(cell.textContent);
        });
        wsData.push(headers);
        currentRow++;
        
        // Add data rows
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const rowData = [];
          const cells = row.querySelectorAll('td');
          cells.forEach((cell, index) => {
            let cellValue = cell.innerText || cell.textContent || '';
            
            // Convert text amounts to numbers for Excel (remove formatting)
            if (index === cells.length - 1) { // Amount column
              cellValue = cellValue.replace(/,/g, '').replace(/Rs\.\s*/, '').replace(/[()]/g, '');
              cellValue = parseFloat(cellValue) || 0;
            }
            
            rowData.push(cellValue);
          });
          wsData.push(rowData);
          currentRow++;
        });
      });
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Set column widths
      const colWidths = [
        { wch: 35 }, // Customer Name
        { wch: 20 }, // Invoice No
        { wch: 15 }, // Date
        { wch: 25 }, // Description
        { wch: 20 }  // Amount
      ];
      ws['!cols'] = colWidths;
      
      // Apply professional styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      // Style title and headers
      for (let R = 0; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;
          
          // Company title styling
          if (R === 0) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 16, color: { rgb: "00264D" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            }
          }
          // Report title styling
          else if (R === 1) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 14, color: { rgb: "003366" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
            // Merge report title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } });
            }
          }
          // Date information styling
          else if (R === 2 || R === 3) {
            ws[cellAddress].s = {
              font: { sz: 11, color: { rgb: "666666" } },
              alignment: { horizontal: "center" }
            };
            // Merge date cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          // Check if this is a section title
          else if (wsData[R] && wsData[R].length === 1 && wsData[R][0].includes('Outstanding')) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 13, color: { rgb: "003366" } },
              alignment: { horizontal: "left", vertical: "center" },
              fill: { fgColor: { rgb: "F0F8FF" } }
            };
            // Merge section title cells
            if (C === 0) {
              ws['!merges'] = ws['!merges'] || [];
              ws['!merges'].push({ s: { r: R, c: 0 }, e: { r: R, c: 4 } });
            }
          }
          // Check if this is a header row
          else if (wsData[R] && wsData[R].length > 1 && 
                   (wsData[R][0] === 'Customer Name' || wsData[R][0] === 'Invoice No / Ref')) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "3399FF" } },
              alignment: { horizontal: "center", vertical: "center", wrapText: true },
              border: {
                top: { style: "thin", color: { rgb: "CCE0FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
          }
          // Data rows styling
          else if (wsData[R] && wsData[R].length > 1 && 
                   !wsData[R][0].includes('Total Outstanding')) {
            ws[cellAddress].s = {
              font: { sz: 11 },
              alignment: { 
                horizontal: (C === 4) ? "right" : "left",
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E6F2FF" } },
                bottom: { style: "thin", color: { rgb: "E6F2FF" } },
                left: { style: "thin", color: { rgb: "E6F2FF" } },
                right: { style: "thin", color: { rgb: "E6F2FF" } }
              },
              fill: { fgColor: { rgb: "FFFFFF" } }
            };
            
            // Apply accounting number format to amount column
            if (C === 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
          // Totals row styling
          else if (wsData[R] && wsData[R].length > 1 && 
                   wsData[R][0] && wsData[R][0].includes('Total Outstanding')) {
            ws[cellAddress].s = {
              font: { bold: true, sz: 12, color: { rgb: "00264D" } },
              fill: { fgColor: { rgb: "E6F2FF" } },
              alignment: { 
                horizontal: (C === 4) ? "right" : "right",
                vertical: "center"
              },
              border: {
                top: { style: "medium", color: { rgb: "3399FF" } },
                bottom: { style: "thin", color: { rgb: "CCE0FF" } },
                left: { style: "thin", color: { rgb: "CCE0FF" } },
                right: { style: "thin", color: { rgb: "CCE0FF" } }
              }
            };
            
            // Apply accounting number format to amount column
            if (C === 4) {
              ws[cellAddress].z = '"Rs. "#,##0.00';
            }
          }
        }
      }
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, `Site ${currentSiteCode}`);
      
      // Generate and download the Excel file
      const fileName = `Site Code ${currentSiteCode}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    async function searchByInvoiceNo() {
      const input = document.getElementById('invoiceNoInput').value.trim();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter an invoice number to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      let found = null;

      rows.forEach(row => {
        const invNo = row.c[3]?.v?.toString().toUpperCase() || '';
        if (invNo === input.toUpperCase()) {
          found = {
            siteCode: row.c[1]?.v || '',
            customerName: row.c[2]?.v || '',
            invNo,
            // Get date from Column E (index 4)
            dueDate: row.c[4]?.f || row.c[4]?.v || '',
            description: row.c[5]?.v || '',
            amount: formatAmount(row.c[6]?.v || 0),
          };
        }
      });

      if (!found) {
        resultsDiv.innerHTML = `<div class="not-found">No invoice found with Invoice Number: <strong>${input}</strong></div>`;
        return;
      }

      resultsDiv.innerHTML = `
        <div class="section-title">Invoice Details</div>
        <table>
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer Name</th>
              <th>Site Code</th>
              <th>Date</th>
              <th>Description</th>
              <th>Amount (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${found.invNo}</td>
              <td>${found.customerName}</td>
              <td>${found.siteCode}</td>
              <td>${found.dueDate}</td>
              <td>${found.description}</td>
              <td class="amount">${found.amount}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding Invoices Summary', 40, 60);
      if (currentSiteCode) {
        doc.text(`Site Code: ${currentSiteCode}`, 40, 80);
      }

      const tables = document.querySelectorAll('#results table');
      let startY = 100;

      tables.forEach(table => {
        doc.autoTable({
          html: table,
          startY,
          theme: 'grid',
          headStyles: { fillColor: [51,153,255], halign: 'center' },
          styles: { fontSize: 9, cellPadding: 4, lineColor: [204,204,204], lineWidth: 0.1 },
          columnStyles: { [table.rows[0].cells.length - 1]: { halign: 'right' } },
          margin: { left: 40, right: 40 },
        });
        startY = doc.lastAutoTable.finalY + 18;
      });

      const totalText = document.querySelector('.grand-total')?.innerText || '';
      if (totalText) {
        // Remove "Without Excess Payments" text from the PDF
        const cleanTotalText = totalText.replace(' - Without Excess Payments', '');
        doc.text(cleanTotalText, 40, startY + 8);
      }

      const fileName = currentSiteCode
        ? `Outstanding Invoices Summary-${currentSiteCode}.pdf`
        : `Outstanding Invoices Summary.pdf`;
      doc.save(fileName);
    }
  </script>
</body>
</html>
