<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice Search by Site Code, Invoice No, or Customer Name</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e6f2ff;
      padding: 40px;
      color: #004080;
    }
    h1 {
      text-align: center;
      color: #00264d;
      font-weight: 700;
      margin-bottom: 5px;
      font-size: 28px;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .as-of-date {
      text-align: center;
      font-size: 16px;
      color: #003366;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .login-container h2 {
      margin-top: 0;
      color: #00264d;
    }
    .login-container input[type="text"],
    .login-container input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      outline: none;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    .login-container button {
      width: 100%;
      padding: 12px 22px;
      font-size: 16px;
      background-color: #3399ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: background-color 0.3s ease;
    }
    .login-container button:hover {
      background-color: #1a8cff;
    }
    .error-message {
      color: #cc0000;
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
    .success-message {
      color: #008000;
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
    }
    #mainApp {
      display: none;
    }
    .logout-btn {
      display: block;
      margin: 30px auto;
      padding: 12px 24px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .logout-btn:hover {
      background-color: #002244;
    }
    .search-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
    }
    .search-box.wide {
      width: 680px;
    }
    input[type="text"] {
      padding: 12px 16px;
      font-size: 16px;
      width: 90%;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button {
      padding: 12px 22px;
      font-size: 16px;
      background-color: #3399ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover { background-color: #1a8cff; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #cce0ff;
      padding: 12px 14px;
      text-align: left;
    }
    th {
      background-color: #cce6ff;
      color: #003366;
    }
    td.amount { text-align: right; font-family: 'Courier New', Courier, monospace; }
    td.payment { color: #008000; font-weight: 600; }
    .section-title {
      margin-top: 40px;
      font-size: 22px;
      font-weight: 600;
      color: #003366;
      border-bottom: 2px solid #3399ff;
      padding-bottom: 6px;
    }
    .not-found {
      text-align: center;
      font-weight: 700;
      color: #cc0000;
      margin-top: 30px;
      font-size: 18px;
    }
    .grand-total {
      margin-top: 30px;
      text-align: right;
      font-size: 20px;
      font-weight: 700;
      color: #00264d;
    }
    .pdf-button {
      display: block;
      margin: 30px auto 0;
      width: 250px;
      background-color: #004080;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .pdf-button:hover { background-color: #063a73; }
    a.site-link {
      color: #004080;
      text-decoration: underline;
      cursor: pointer;
    }
    .summary-totals {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      gap: 20px;
      flex-wrap: wrap;
    }
    .summary-card {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      text-align: center;
      min-width: 200px;
    }
    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #003366;
      font-size: 18px;
    }
    .summary-card .amount-big {
      font-size: 24px;
      font-weight: 700;
      color: #00264d;
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h1>DOK Solutions Lanka (Pvt) Ltd</h1>
    <h2>Login to Outstanding Summary</h2>
    <input type="text" id="username" placeholder="Enter Username" onkeypress="handleLoginKeyPress(event)" />
    <input type="password" id="password" placeholder="Enter Password" onkeypress="handleLoginKeyPress(event)" />
    <button onclick="login()">Login</button>
    <div id="loginMessage"></div>
  </div>

  <!-- Main Application (Hidden until login) -->
  <div id="mainApp">
    <h1>DOK Solutions Lanka (Pvt) Ltd</h1>
    <h2>Outstanding Invoice Search</h2>
    <div id="asOfDate" class="as-of-date"></div>

    <div class="search-container">
      <div class="search-box">
        <h3>Search by Site Code</h3>
        <input type="text" id="siteCodeInput" placeholder="Enter Site Code (e.g. CCC01)" onkeypress="handleKeyPress(event, 'site')" />
        <button onclick="searchBySiteCode()">Search Site Code</button>
      </div>

      <div class="search-box">
        <h3>Search by Invoice Number</h3>
        <input type="text" id="invoiceNoInput" placeholder="Enter Invoice Number" onkeypress="handleKeyPress(event, 'invoice')" />
        <button onclick="searchByInvoiceNo()">Search Invoice No</button>
      </div>

      <div class="search-box wide">
        <h3>Find Site by Customer Name</h3>
        <input type="text" id="customerNameInput" placeholder="Enter part of Customer Name" onkeypress="handleKeyPress(event, 'customer')" />
        <button onclick="searchByCustomerName()">Find Site</button>
      </div>

      <div class="search-box wide">
        <h3>Total Customer Outstanding Summary</h3>
        <button onclick="showCustomerSummary()">Show All Customer Outstandings</button>
      </div>
    </div>

    <div id="results"></div>
    
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1pwJypDTNH5ouw4BZ7gB_2AchH1TRktzhKxVaBGg7hzo/gviz/tq?tqx=out:json';
    let currentSiteCode = '';
    let currentSummaryData = null;
    let isLoggedIn = false;

    async function fetchSheetData() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        if (!json.table || !json.table.rows) return [];
        return json.table.rows;
      } catch (error) {
        console.error('Error fetching sheet data:', error);
        return [];
      }
    }

    function handleLoginKeyPress(event) {
      if (event.key === 'Enter') {
        login();
      }
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const messageDiv = document.getElementById('loginMessage');

      if (!username || !password) {
        messageDiv.innerHTML = '<div class="error-message">Please enter both username and password</div>';
        return;
      }

      messageDiv.innerHTML = '<div class="success-message">Validating credentials...</div>';

      const rows = await fetchSheetData();
      let loginSuccess = false;

      // Check credentials from columns J (index 9) and K (index 10)
      // Starting from row 2 (index 1) as row 1 is header
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        
        // Get username from column J (index 9) and password from column K (index 10)
        const storedUsername = row.c[9]?.v?.toString().trim() || '';
        const storedPassword = row.c[10]?.v?.toString().trim() || '';

        if (storedUsername === username && storedPassword === password) {
          loginSuccess = true;
          break;
        }
      }

      if (loginSuccess) {
        messageDiv.innerHTML = '<div class="success-message">Login successful! Redirecting...</div>';
        isLoggedIn = true;
        
        setTimeout(async () => {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          // Fetch and display "As of Date" after showing main app
          await fetchAsOfDate();
        }, 1000);
      } else {
        messageDiv.innerHTML = '<div class="error-message">Invalid username or password</div>';
        document.getElementById('password').value = '';
      }
    }

    function logout() {
      isLoggedIn = false;
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginMessage').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('asOfDate').innerHTML = '';
    }

    async function fetchAsOfDate() {
      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        
        console.log('Full JSON:', json);
        
        if (json.table && json.table.cols && json.table.cols.length > 0) {
          // Get the label from the first column header which contains A1 data
          const firstColLabel = json.table.cols[0].label || '';
          console.log('Column label (A1):', firstColLabel);
          
          if (firstColLabel) {
            document.getElementById('asOfDate').innerHTML = firstColLabel.toString();
          } else {
            document.getElementById('asOfDate').innerHTML = 'As of Date not found';
          }
        }
      } catch (error) {
        console.error('Error fetching As of Date:', error);
        document.getElementById('asOfDate').innerHTML = 'Error loading date';
      }
    }

    function handleKeyPress(event, type) {
      if (event.key === 'Enter') {
        if (type === 'site') searchBySiteCode();
        else if (type === 'invoice') searchByInvoiceNo();
        else if (type === 'customer') searchByCustomerName();
      }
    }

    function formatAmount(num) {
      return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    async function showCustomerSummary() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="not-found">Loading customer summary data...</div>`;

      const rows = await fetchSheetData();
      const customerData = {};

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        const description = row.c[5]?.v || '';
        const amountRaw = row.c[6]?.v || 0;

        if (!siteCode || !customerName) return;

        if (!customerData[siteCode]) {
          customerData[siteCode] = {
            customerName,
            paTotal: 0,
            daTotal: 0,
            excessPayment: 0
          };
        }

        if (description === 'PA Manual Invoice') {
          customerData[siteCode].paTotal += amountRaw;
        } else if (description === 'DA Manual Invoice') {
          customerData[siteCode].daTotal += amountRaw;
        } else if (description.toLowerCase() === 'payment') {
          customerData[siteCode].excessPayment += amountRaw;
        }
      });

      const summaryArray = Object.entries(customerData).map(([siteCode, data]) => ({
        siteCode,
        customerName: data.customerName,
        paTotal: data.paTotal,
        daTotal: data.daTotal,
        excessPayment: data.excessPayment,
        grandTotal: data.paTotal + data.daTotal + data.excessPayment
      })).filter(item => item.paTotal !== 0 || item.daTotal !== 0 || item.excessPayment !== 0);

      summaryArray.sort((a, b) => a.customerName.localeCompare(b.customerName));

      currentSummaryData = summaryArray;

      if (summaryArray.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No outstanding invoices found.</div>`;
        return;
      }

      let totalPA = 0;
      let totalDA = 0;
      let totalExcess = 0;
      let totalGrand = 0;

      let html = `<div class="section-title">Total Customer Outstanding Summary (PA & DA)</div>
                  <table>
                    <thead>
                      <tr>
                        <th>Customer Name</th>
                        <th>Site Code</th>
                        <th>PA Outstanding (Rs.)</th>
                        <th>DA Outstanding (Rs.)</th>
                        <th>Excess Payment (Rs.)</th>
                        <th>Total Outstanding (Rs.)</th>
                      </tr>
                    </thead>
                    <tbody>`;

      summaryArray.forEach(item => {
        totalPA += item.paTotal;
        totalDA += item.daTotal;
        totalExcess += item.excessPayment;
        totalGrand += item.grandTotal;

        const excessDisplay = item.excessPayment < 0 
          ? `(${formatAmount(Math.abs(item.excessPayment))})` 
          : formatAmount(item.excessPayment);
        const excessClass = item.excessPayment < 0 ? 'amount payment' : 'amount';

        html += `<tr>
          <td>${item.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${item.siteCode}')">${item.siteCode}</a></td>
          <td class="amount">${formatAmount(item.paTotal)}</td>
          <td class="amount">${formatAmount(item.daTotal)}</td>
          <td class="${excessClass}">${excessDisplay}</td>
          <td class="amount" style="font-weight: 700;">${formatAmount(item.grandTotal)}</td>
        </tr>`;
      });

      const totalExcessDisplay = totalExcess < 0 
        ? `(${formatAmount(Math.abs(totalExcess))})` 
        : formatAmount(totalExcess);

      html += `<tr style="background-color: #e6f2ff; font-weight: 700;">
        <td colspan="2" style="text-align: right;">GRAND TOTAL</td>
        <td class="amount">${formatAmount(totalPA)}</td>
        <td class="amount">${formatAmount(totalDA)}</td>
        <td class="amount payment">${totalExcessDisplay}</td>
        <td class="amount">${formatAmount(totalGrand)}</td>
      </tr>`;

      html += `</tbody></table>`;

      html += `<div class="summary-totals">
        <div class="summary-card">
          <h3>Total PA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalPA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total DA Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalDA)}</div>
        </div>
        <div class="summary-card">
          <h3>Total Excess Payments</h3>
          <div class="amount-big" style="color: #008000;">${totalExcess < 0 ? '(' : ''}Rs. ${formatAmount(Math.abs(totalExcess))}${totalExcess < 0 ? ')' : ''}</div>
        </div>
        <div class="summary-card">
          <h3>Net Total Outstanding</h3>
          <div class="amount-big">Rs. ${formatAmount(totalGrand)}</div>
        </div>
      </div>`;

      html += `<button class="pdf-button" onclick="downloadSummaryPDF()">Download Summary as PDF</button>`;

      resultsDiv.innerHTML = html;
    }

    function downloadSummaryPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Total Customer Outstanding Summary (PA & DA)', 40, 60);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);

      const table = document.querySelector('#results table');
      
      doc.autoTable({
        html: table,
        startY: 100,
        theme: 'grid',
        headStyles: { fillColor: [51,153,255], halign: 'center', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3, lineColor: [204,204,204], lineWidth: 0.1 },
        columnStyles: { 
          2: { halign: 'right' },
          3: { halign: 'right' },
          4: { halign: 'right' },
          5: { halign: 'right' }
        },
        margin: { left: 40, right: 40 },
      });

      doc.save('Customer Outstanding Summary.pdf');
    }

    async function searchByCustomerName() {
      const input = document.getElementById('customerNameInput').value.trim().toLowerCase();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter part of a customer name.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      const matches = [];

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        const customerName = row.c[2]?.v?.toString() || '';
        if (customerName.toLowerCase().includes(input)) {
          if (!matches.find(m => m.siteCode === siteCode)) {
            matches.push({ siteCode, customerName });
          }
        }
      });

      if (matches.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No sites found for Customer Name containing: <strong>${input}</strong></div>`;
        return;
      }

      let html = `<div class="section-title">Matching Sites</div><table><thead><tr>
        <th>Customer Name</th><th>Site Code</th></tr></thead><tbody>`;

      matches.forEach(m => {
        html += `<tr>
          <td>${m.customerName}</td>
          <td><a class="site-link" onclick="searchBySiteCode('${m.siteCode}')">${m.siteCode}</a></td>
        </tr>`;
      });

      html += `</tbody></table>`;
      resultsDiv.innerHTML = html;
    }

    async function searchBySiteCode(code = null) {
      const input = (code || document.getElementById('siteCodeInput').value.trim().toUpperCase());
      currentSiteCode = input;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter a site code to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      const paInvoices = [];
      const daInvoices = [];
      const payments = [];

      rows.forEach(row => {
        const siteCode = row.c[1]?.v?.toString().toUpperCase() || '';
        if (siteCode === input) {
          const customerName = row.c[2]?.v || '';
          const invNo = row.c[3]?.v || '';
          const date = row.c[4]?.f || row.c[4]?.v || '';
          const description = row.c[5]?.v || '';
          const amountRaw = row.c[6]?.v || 0;
          const record = { customerName, invNo, date, description, amountRaw };

          if (description === 'PA Manual Invoice') paInvoices.push(record);
          else if (description === 'DA Manual Invoice') daInvoices.push(record);
          else if (description.toLowerCase() === 'payment') payments.push(record);
        }
      });

      function parseDate(d) {
        const parsed = Date.parse(d);
        return isNaN(parsed) ? new Date(d.replace(/(\d{2})[-/](\w+)[-/](\d{2,4})/, '$2 $1 $3')) : new Date(parsed);
      }

      function sortAndAppendPayments(invoices) {
        const normalInvoices = invoices.filter(i => !i.description.toLowerCase().includes('payment'));
        const paymentRows = invoices.filter(i => i.description.toLowerCase().includes('payment'));
        normalInvoices.sort((a, b) => parseDate(a.date) - parseDate(b.date));
        return [...normalInvoices, ...paymentRows];
      }

      const sortedPA = sortAndAppendPayments(paInvoices);
      const sortedDA = sortAndAppendPayments(daInvoices);

      payments.forEach(p => {
        const record = { ...p, description: 'Excess Payment', amountRaw: -Math.abs(p.amountRaw) };
        if (sortedPA.length > 0 && sortedDA.length === 0) sortedPA.push(record);
        else if (sortedDA.length > 0 && sortedPA.length === 0) sortedDA.push(record);
        else sortedPA.push(record);
      });

      if (sortedPA.length === 0 && sortedDA.length === 0) {
        resultsDiv.innerHTML = `<div class="not-found">No invoices or payments found for Site Code: <strong>${input}</strong></div>`;
        return;
      }

      function buildTable(title, invoices) {
        let total = 0;
        let tableHTML = `<div class="section-title">${title}</div><table><thead><tr>
          <th>Customer Name</th><th>Invoice No / Ref</th><th>Date</th><th>Description</th><th>Amount (Rs.)</th>
        </tr></thead><tbody>`;

        invoices.forEach(({ customerName, invNo, date, description, amountRaw }) => {
          const isPayment = description.toLowerCase().includes('payment');
          const displayAmount = isPayment ? `(${formatAmount(Math.abs(amountRaw))})` : formatAmount(amountRaw);
          const amountClass = isPayment ? 'amount payment' : 'amount';
          total += amountRaw;

          tableHTML += `<tr>
            <td>${customerName}</td>
            <td>${invNo}</td>
            <td>${date}</td>
            <td>${description}</td>
            <td class="${amountClass}">${displayAmount}</td>
          </tr>`;
        });

        tableHTML += `<tr><td colspan="4" style="text-align:right; font-weight:700;">Total Outstanding</td>
          <td class="amount" style="font-weight:700;">${formatAmount(total)}</td></tr></tbody></table>`;
        return { html: tableHTML, total };
      }

      let html = '';
      let paTotal = 0;
      let daTotal = 0;
      if (sortedPA.length > 0) {
        const { html: paHTML, total } = buildTable('Outstanding PA Invoices', sortedPA);
        html += paHTML; paTotal = total;
      }
      if (sortedDA.length > 0) {
        const { html: daHTML, total } = buildTable('Outstanding DA Invoices', sortedDA);
        html += daHTML; daTotal = total;
      }

      const grandTotal = paTotal + daTotal;
      html += `<div class="grand-total">Total Outstanding (PA + DA): Rs. ${formatAmount(grandTotal)}</div>
               <button class="pdf-button" onclick="downloadPDF()">Download as PDF</button>`;
      resultsDiv.innerHTML = html;
    }

    async function searchByInvoiceNo() {
      const input = document.getElementById('invoiceNoInput').value.trim();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!input) {
        resultsDiv.innerHTML = `<div class="not-found">Please enter an invoice number to search.</div>`;
        return;
      }

      resultsDiv.innerHTML = `<div class="not-found">Loading data...</div>`;

      const rows = await fetchSheetData();
      let found = null;

      rows.forEach(row => {
        const invNo = row.c[3]?.v?.toString().toUpperCase() || '';
        if (invNo === input.toUpperCase()) {
          found = {
            siteCode: row.c[1]?.v || '',
            customerName: row.c[2]?.v || '',
            invNo,
            dueDate: row.c[4]?.f || row.c[4]?.v || '',
            description: row.c[5]?.v || '',
            amount: formatAmount(row.c[6]?.v || 0),
          };
        }
      });

      if (!found) {
        resultsDiv.innerHTML = `<div class="not-found">No invoice found with Invoice Number: <strong>${input}</strong></div>`;
        return;
      }

      resultsDiv.innerHTML = `
        <div class="section-title">Invoice Details</div>
        <table>
          <thead>
            <tr>
              <th>Invoice No</th>
              <th>Customer Name</th>
              <th>Site Code</th>
              <th>Date</th>
              <th>Description</th>
              <th>Amount (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${found.invNo}</td>
              <td>${found.customerName}</td>
              <td>${found.siteCode}</td>
              <td>${found.dueDate}</td>
              <td>${found.description}</td>
              <td class="amount">${found.amount}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

      doc.setFontSize(14);
      doc.text('DOK Solutions Lanka (Pvt) Ltd', 40, 40);
      doc.setFontSize(12);
      doc.text('Outstanding Invoices Summary', 40, 60);
      if (currentSiteCode) doc.text(`Site Code: ${currentSiteCode}`, 40, 80);

      const tables = document.querySelectorAll('#results table');
      let startY = 100;

      tables.forEach(table => {
        doc.autoTable({
          html: table,
          startY,
          theme: 'grid',
          headStyles: { fillColor: [51,153,255], halign: 'center' },
          styles: { fontSize: 9, cellPadding: 4, lineColor: [204,204,204], lineWidth: 0.1 },
          columnStyles: { [table.rows[0].cells.length - 1]: { halign: 'right' } },
          margin: { left: 40, right: 40 },
        });
        startY = doc.lastAutoTable.finalY + 18;
      });

      const totalText = document.querySelector('.grand-total')?.innerText || '';
      if (totalText) doc.text(totalText, 40, startY + 8);

      const fileName = currentSiteCode
        ? `Outstanding Invoices Summary-${currentSiteCode}.pdf`
        : `Outstanding Invoices Summary.pdf`;
      doc.save(fileName);
    }
  </script>
</body>
</html>